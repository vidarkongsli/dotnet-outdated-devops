parameters:
- name: projects
  type: object
  default:
  - a:
    repository: dependabot-test
    projectFile: 2
  - b:
    repository: pipeline-triggers
    projectFile: 3

variables:
  organization: elektroniskdatabehandling

steps:
- pwsh: |
    az devops configure --defaults organization=https://dev.azure.com/elektroniskdatabehandling/
- checkout: self
- ${{ each project in parameters.projects }}:
  - checkout: git://eksempler/${{ project['repository'] }}

  - pwsh: |
      $tempFile = New-TemporaryFile
      Write-Output $env:PROJECT_ID > $tempFile
      $hash = Get-FileHash -Path $tempFile -Algorithm MD5 | Select-Object -ExpandProperty Hash
      Write-host "Hash is $hash"
    env:
      PROJECT_FILE: ${{ project['projectFile'] }}

  - pwsh: |
      Write-host "Retrieving PRs in repository $env:REPO_ID"
      $headers = @{'Authorization'="Bearer $env:AZURE_DEVOPS_EXT_PAT"}
      $uri = "https://dev.azure.com/$env:ORG/$env:PROJECT_ID/_apis/git/repositories/$env:REPO_ID/pullrequests?api-version=7.1-preview.1"
      Write-host "Uri is $uri"
      $pullRequests = Invoke-RestMethod -Method GET -Uri $uri -Headers $headers `
        | Select-Object -ExpandProperty value
      $pullRequests
    env:
      AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)
      PROJECT_ID: $(System.TeamProjectId)
      ORG: $(organization)
      REPO_ID: ${{ project['repository'] }}
      
- script: dir $(Build.SourcesDirectory)
